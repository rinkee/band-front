-- ============================================================================
-- Supabase ì¸ë±ìŠ¤ ìµœì í™” ê¶Œì¥ì‚¬í•­
-- ë¶„ì„ì¼: 2025-12-10
-- ê¸°ì¤€: Supabase Query Performance Statements CSV
-- ê²€ì¦: Claude + GPT ë”ë¸”ì²´í¬ ì™„ë£Œ âœ…
-- ============================================================================

-- ============================================================================
-- 1. ë¶„ì„ ìš”ì•½
-- ============================================================================
/*
ì „ì²´ DB ë¶€í•˜ ë¶„ì„ (ì¸¡ì • ê¸°ê°„ ë‚´):
- ì´ ëŠë¦° ì¿¼ë¦¬ ì‹œê°„: 491.8ì´ˆ (CSV total_time í•©ê³„)
- ê°€ì¥ í° ë³‘ëª©: UPDATE orders JOIN products (19.9%, 13.9ì´ˆ/ì¿¼ë¦¬)

ì£¼ìš” ë¬¸ì œì :
1. posts í…Œì´ë¸”ì— user_id ì¸ë±ìŠ¤ ì „ë¬´ â†’ Full Table Scan ë°œìƒ (DB ì¡°íšŒ í™•ì¸ë¨)
2. orders JOIN ì¿¼ë¦¬ì— ë³µí•© ì¸ë±ìŠ¤ ë¶€ì¬ â†’ 14ì´ˆ ì†Œìš”
3. products ëª©ë¡ ì¿¼ë¦¬ ìµœì í™” í•„ìš”
*/

-- ============================================================================
-- 2. ê¸°ì¡´ ì¸ë±ìŠ¤ í˜„í™© (2025-12-10 pg_indexes ì¡°íšŒ ê²°ê³¼)
-- ============================================================================
/*
â€» ì•„ë˜ ëª©ë¡ì€ ì‹¤ì œ DBì—ì„œ pg_indexes ì¡°íšŒí•œ ê²°ê³¼ì…ë‹ˆë‹¤.

[orders í…Œì´ë¸”] - 12ê°œ
- orders_pkey (order_id)
- idx_orders_user_id_ordered_at (user_id, ordered_at) â† ì¡´ì¬ í™•ì¸ë¨, #3ê³¼ ì¤‘ë³µ
- idx_orders_user_status_ordered (user_id, status, ordered_at DESC)
- idx_orders_user_postkey (user_id, post_key)
- idx_orders_user_customer (user_id, customer_name)
- idx_orders_post_key (post_key)
- idx_orders_sub_status (sub_status)
- idx_orders_comment_trgm (GIN comment)
- idx_orders_customer_name_trgm (GIN customer_name)
- idx_orders_matching_metadata (GIN)
- idx_orders_selected_barcode_option (GIN)
- idx_orders_processing_method (processing_method)

[posts í…Œì´ë¸”] - 5ê°œ (user_id ì¸ë±ìŠ¤ ì—†ìŒ - DB ì¡°íšŒë¡œ í™•ì¸ë¨!)
- posts_pkey (post_id)
- posts_post_id_key (post_id)
- unique_band_post (band_number, unique_post_id)
- idx_posts_comment_sync_status (partial)
- idx_posts_keyword_mappings (GIN)

[products í…Œì´ë¸”] - 12ê°œ
- products_pkey (product_id)
- idx_products_user_band_post (user_id, band_key, post_key)
- idx_products_user_pickup (user_id, pickup_date)
- idx_products_pickup_date (pickup_date) WHERE pickup_date IS NOT NULL
- idx_products_title_trgm (GIN)
- idx_products_barcode_options_gin (GIN)
- ê¸°íƒ€ barcode, price ê´€ë ¨ ì¸ë±ìŠ¤ë“¤
*/

-- ============================================================================
-- 3. ì¸ë±ìŠ¤ë³„ ì˜ˆìƒ ê°œì„  íš¨ê³¼
-- ============================================================================
/*
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ìˆœìœ„: posts í…Œì´ë¸” (user_id ì¸ë±ìŠ¤ ì „ë¬´ - ê°€ì¥ ì‹œê¸‰)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì¸ë±ìŠ¤                              â”‚ í˜„ì¬      â”‚ ì˜ˆìƒ     â”‚ ê°œì„ ìœ¨      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ idx_posts_user_posted_at            â”‚ 478ms     â”‚ 10-50ms  â”‚ 90% â†‘       â”‚
â”‚ idx_posts_user_is_product_posted_at â”‚ 156ms     â”‚ 5-20ms   â”‚ 85% â†‘       â”‚
â”‚ idx_posts_user_post_key             â”‚ 24ms      â”‚ 1-5ms    â”‚ 80% â†‘       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ìˆœìœ„: orders í…Œì´ë¸”                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì¸ë±ìŠ¤                              â”‚ í˜„ì¬      â”‚ ì˜ˆìƒ     â”‚ ê°œì„ ìœ¨      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ idx_orders_user_band_post_status    â”‚ 13,969ms  â”‚ 100-500msâ”‚ 95% â†‘ ğŸ”¥    â”‚
â”‚ idx_orders_user_updated_at          â”‚ 373ms     â”‚ 10-30ms  â”‚ 90% â†‘       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â€» idx_orders_user_band_post_statusëŠ” ì „ì²´ DB ë¶€í•˜ì˜ 20%ë¥¼ ì°¨ì§€í•˜ëŠ” ì¿¼ë¦¬ ìµœì í™”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ìˆœìœ„: products í…Œì´ë¸”                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì¸ë±ìŠ¤                              â”‚ í˜„ì¬      â”‚ ì˜ˆìƒ     â”‚ ê°œì„ ìœ¨      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ idx_products_user_band_post_pickupdate â”‚ (JOIN)  â”‚ -        â”‚ 95% â†‘       â”‚
â”‚ idx_products_user_status_posted_at  â”‚ 489ms     â”‚ 10-30ms  â”‚ 95% â†‘       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ìˆœìœ„: trigram ê²€ìƒ‰ (ILIKE ìµœì í™”)                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì¸ë±ìŠ¤                              â”‚ í˜„ì¬      â”‚ ì˜ˆìƒ     â”‚ ê°œì„ ìœ¨      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ idx_posts_trgm_search               â”‚ 104ms     â”‚ 20-50ms  â”‚ 50-70% â†‘    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì´ ì˜ˆìƒ íš¨ê³¼: DB ë¶€í•˜ 70-80% ê°ì†Œ
*/

-- ============================================================================
-- 4. ì‹¤í–‰ ì£¼ì˜ì‚¬í•­ âš ï¸
-- ============================================================================
/*
1. ë½(Lock) ê´€ë ¨ ì£¼ì˜
   - ì¼ë°˜ CREATE INDEX: í…Œì´ë¸”ì— Exclusive Lock ë°œìƒ (ì“°ê¸° ì°¨ë‹¨)
   - CREATE INDEX CONCURRENTLY: ë½ ì—†ì´ ìƒì„± (ê¶Œì¥, ë‹¨ ë” ì˜¤ë˜ ê±¸ë¦¼)

2. Supabase SQL Editor ì œí•œ
   - CONCURRENTLYëŠ” íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì‹¤í–‰ ë¶ˆê°€
   - Supabase SQL EditorëŠ” ê¸°ë³¸ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ê°ì‹¸ì„œ ì‹¤í–‰
   - í•´ê²°ì±…:
     a) ì¼ë°˜ CREATE INDEX ì‚¬ìš© (íŠ¸ë˜í”½ ì ì€ ì‹œê°„ëŒ€)
     b) psql ì§ì ‘ ì—°ê²° í›„ CONCURRENTLY ì‹¤í–‰

3. ì‹¤í–‰ ë°©ë²•
   - ê° êµ¬ë¬¸ì„ ê°œë³„ ì‹¤í–‰ (í•œ ë²ˆì— í•˜ë‚˜ì”©)
   - í…Œì´ë¸” í¬ê¸° í™•ì¸ í›„ ì‹¤í–‰:
     * 10ë§Œ row ì´í•˜: ë°”ë¡œ ì‹¤í–‰ OK (ëª‡ ì´ˆ)
     * 100ë§Œ row ì´ìƒ: íŠ¸ë˜í”½ ì ì€ ì‹œê°„ëŒ€ ê¶Œì¥

4. trigram ì¸ë±ìŠ¤ (#8) íŠ¹ë³„ ì£¼ì˜
   - GIN ì¸ë±ìŠ¤ëŠ” ìƒì„± ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¼
   - ë””ìŠ¤í¬ ê³µê°„ ë§ì´ ì°¨ì§€ (ì›ë³¸ì˜ 2-3ë°°)
   - ê°œë°œ DBì—ì„œ ë¨¼ì € í…ŒìŠ¤íŠ¸ ê¶Œì¥
*/

-- ============================================================================
-- 5. ì¶”ê°€í•´ì•¼ í•  ì¸ë±ìŠ¤ (ì´ 8ê°œ, ìš°ì„ ìˆœìœ„ ìˆœ)
-- ============================================================================

-- ============================================================================
-- [1ìˆœìœ„] posts í…Œì´ë¸” - user_id ì¸ë±ìŠ¤ ì „ë¬´ë¡œ ê°€ì¥ ì‹œê¸‰
-- ============================================================================

-- 1-1. posts ê¸°ë³¸ ì •ë ¬ ì¸ë±ìŠ¤
-- ëŒ€ìƒ: SELECT * FROM posts WHERE user_id = ? ORDER BY posted_at DESC
-- í˜„ì¬: 478ms â†’ ì˜ˆìƒ: 10-50ms (90% ê°œì„ )
CREATE INDEX IF NOT EXISTS idx_posts_user_posted_at
  ON public.posts (user_id, posted_at DESC);

-- 1-2. posts is_product í•„í„°ìš©
-- ëŒ€ìƒ: SELECT * FROM posts WHERE user_id = ? AND is_product = ?
-- í˜„ì¬: 156ms â†’ ì˜ˆìƒ: 5-20ms (85% ê°œì„ )
CREATE INDEX IF NOT EXISTS idx_posts_user_is_product_posted_at
  ON public.posts (user_id, is_product, posted_at DESC);

-- 1-3. posts post_key ANY ì¡°íšŒìš©
-- ëŒ€ìƒ: SELECT * FROM posts WHERE user_id = ? AND post_key = ANY(?)
-- í˜„ì¬: 24ms â†’ ì˜ˆìƒ: 1-5ms (80% ê°œì„ )
CREATE INDEX IF NOT EXISTS idx_posts_user_post_key
  ON public.posts (user_id, post_key);

-- ============================================================================
-- [2ìˆœìœ„] orders í…Œì´ë¸”
-- ============================================================================

-- 2-1. orders JOINìš© (UPDATE ì¿¼ë¦¬ ìµœì í™”) ğŸ”¥ ê°€ì¥ ì„íŒ©íŠ¸ í¼
-- ëŒ€ìƒ: UPDATE orders SET sub_status FROM products JOIN...
-- í˜„ì¬: 13,969ms (14ì´ˆ!) â†’ ì˜ˆìƒ: 100-500ms (95% ê°œì„ )
-- â€» ì´ ì¿¼ë¦¬ í•˜ë‚˜ê°€ ì „ì²´ DB ë¶€í•˜ì˜ 20% ì°¨ì§€
CREATE INDEX IF NOT EXISTS idx_orders_user_band_post_status
  ON public.orders (user_id, band_key, post_key, status, sub_status);

-- 2-2. orders updated_at ì •ë ¬ìš©
-- ëŒ€ìƒ: SELECT * FROM orders WHERE user_id = ? ORDER BY updated_at DESC
-- í˜„ì¬: 373ms â†’ ì˜ˆìƒ: 10-30ms (90% ê°œì„ )
CREATE INDEX IF NOT EXISTS idx_orders_user_updated_at
  ON public.orders (user_id, updated_at DESC);

-- ============================================================================
-- [3ìˆœìœ„] products í…Œì´ë¸”
-- ============================================================================

-- 3-1. products JOIN + pickup_date í•„í„°ìš©
-- ëŒ€ìƒ: UPDATE orders JOIN products (ìœ„ 2-1ê³¼ í•¨ê»˜ ì‘ë™)
-- íš¨ê³¼: products í…Œì´ë¸” ìŠ¤ìº” ìµœì í™”, Index Only Scan ê°€ëŠ¥
CREATE INDEX IF NOT EXISTS idx_products_user_band_post_pickupdate
  ON public.products (user_id, band_key, post_key, pickup_date)
  WHERE pickup_date IS NOT NULL;

-- 3-2. products ëª©ë¡/ì¹´ìš´íŠ¸ìš©
-- ëŒ€ìƒ: SELECT * FROM products WHERE user_id = ? AND status = ? ORDER BY posted_at DESC
-- í˜„ì¬: 489ms â†’ ì˜ˆìƒ: 10-30ms (95% ê°œì„ )
CREATE INDEX IF NOT EXISTS idx_products_user_status_posted_at
  ON public.products (user_id, status, posted_at DESC);

-- ============================================================================
-- [4ìˆœìœ„] trigram ê²€ìƒ‰ (ILIKE ìµœì í™”) - ê°œë°œ DB í…ŒìŠ¤íŠ¸ í›„ ì ìš© ê¶Œì¥
-- ============================================================================

-- 4-1. pg_trgm í™•ì¥ í™œì„±í™” (ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œë¨)
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- 4-2. posts ilike ê²€ìƒ‰ìš© GIN ì¸ë±ìŠ¤
-- ëŒ€ìƒ: SELECT * FROM posts WHERE title ILIKE '%ê²€ìƒ‰ì–´%' OR content ILIKE...
-- í˜„ì¬: 104ms â†’ ì˜ˆìƒ: 20-50ms (50-70% ê°œì„ )
-- âš ï¸ ì£¼ì˜: ìƒì„± ì‹œê°„ ì˜¤ë˜ ê±¸ë¦¬ê³ , ë””ìŠ¤í¬ ê³µê°„ ë§ì´ ì°¨ì§€
CREATE INDEX IF NOT EXISTS idx_posts_trgm_search
  ON public.posts
  USING GIN ((coalesce(title, '') || ' ' || coalesce(content, '') || ' ' || coalesce(author_name, '')) gin_trgm_ops);

-- ============================================================================
-- [ì œì™¸] ì¤‘ë³µ ì¸ë±ìŠ¤
-- ============================================================================
/*
ì•„ë˜ ì¸ë±ìŠ¤ëŠ” ê¸°ì¡´ idx_orders_user_id_ordered_atì™€ ê¸°ëŠ¥ì ìœ¼ë¡œ ì¤‘ë³µë˜ì–´ ì œì™¸:
(pg_indexes ì¡°íšŒë¡œ idx_orders_user_id_ordered_at ì¡´ì¬ í™•ì¸ë¨)

-- CREATE INDEX IF NOT EXISTS idx_orders_user_ordered_at
--   ON public.orders (user_id, ordered_at DESC);

ì´ìœ : btree ì¸ë±ìŠ¤ëŠ” ì–‘ë°©í–¥ ìŠ¤ìº” ì§€ì›í•˜ë¯€ë¡œ ASC/DESC ë³„ë„ ìƒì„± ë¶ˆí•„ìš”
*/

-- ============================================================================
-- 6. ì‹¤í–‰ í›„ ê²€ì¦ ì¿¼ë¦¬
-- ============================================================================

-- í…Œì´ë¸” í¬ê¸° í™•ì¸ (ì‹¤í–‰ ì „)
-- SELECT relname, n_live_tup
-- FROM pg_stat_user_tables
-- WHERE relname IN ('posts', 'orders', 'products');

-- ì¸ë±ìŠ¤ ìƒì„± í™•ì¸ (ì‹¤í–‰ í›„)
-- SELECT indexname, indexdef FROM pg_indexes
-- WHERE tablename IN ('orders', 'products', 'posts')
-- AND schemaname = 'public'
-- ORDER BY tablename, indexname;

-- ì¿¼ë¦¬ í”Œëœ í™•ì¸ ì˜ˆì‹œ (ì¸ë±ìŠ¤ ì‚¬ìš© ì—¬ë¶€)
-- EXPLAIN ANALYZE SELECT * FROM posts WHERE user_id = 'xxx' ORDER BY posted_at DESC LIMIT 100;

-- ============================================================================
-- 7. ë¹ ë¥¸ ë³µì‚¬ìš© (Supabase SQL Editorì—ì„œ í•˜ë‚˜ì”© ì‹¤í–‰)
-- ============================================================================
/*
-- [1ìˆœìœ„] posts
CREATE INDEX IF NOT EXISTS idx_posts_user_posted_at ON public.posts (user_id, posted_at DESC);
CREATE INDEX IF NOT EXISTS idx_posts_user_is_product_posted_at ON public.posts (user_id, is_product, posted_at DESC);
CREATE INDEX IF NOT EXISTS idx_posts_user_post_key ON public.posts (user_id, post_key);

-- [2ìˆœìœ„] orders
CREATE INDEX IF NOT EXISTS idx_orders_user_band_post_status ON public.orders (user_id, band_key, post_key, status, sub_status);
CREATE INDEX IF NOT EXISTS idx_orders_user_updated_at ON public.orders (user_id, updated_at DESC);

-- [3ìˆœìœ„] products
CREATE INDEX IF NOT EXISTS idx_products_user_band_post_pickupdate ON public.products (user_id, band_key, post_key, pickup_date) WHERE pickup_date IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_products_user_status_posted_at ON public.products (user_id, status, posted_at DESC);

-- [4ìˆœìœ„] trigram (ì„ íƒ)
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX IF NOT EXISTS idx_posts_trgm_search ON public.posts USING GIN ((coalesce(title, '') || ' ' || coalesce(content, '') || ' ' || coalesce(author_name, '')) gin_trgm_ops);
*/
